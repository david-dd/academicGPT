{% extends "base.html" %}
{% block content %}
<section class="card">
  <div class="split">
    <div>
      <h2>{{ conversation.title }}</h2>
      <p class="muted">Source: {{ conversation.source }}</p>
    </div>
    <div class="row-actions">
      <a href="/p/{{ project.slug }}/conversations">All conversations</a>
    </div>
  </div>
  <details class="context-details">
    <summary>
      <span>Kontext &amp; Metadaten</span>
      <span class="muted">
        ID {{ conversation.id }} ·
        {{ conversation.notes or "Keine Beschreibung" }} ·
        {{ conversation.links | length }} Textbausteine
      </span>
    </summary>
    <div class="context-panel">
      <div>
        <h3>Aktueller Kontext</h3>
        <p class="muted">
          Konversation ID: <strong>{{ conversation.id }}</strong>
        </p>
        <p class="muted">
          Beschreibung: {{ conversation.notes or "Keine Beschreibung vorhanden." }}
        </p>
      </div>
      <div>
        <h4>Textbausteine</h4>
        {% if conversation.links %}
          <ul class="list compact-list">
            {% for link in conversation.links %}
              <li class="list-item">
                <strong>#{{ link.text_block.id }} · {{ link.text_block.title }}</strong>
                <p class="muted">Relation: {{ relation_labels[link.relation] }}</p>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="muted">Noch keine Textbausteine verknüpft.</p>
        {% endif %}
      </div>
    </div>
    <form method="post" action="/p/{{ project.slug }}/conversations/{{ conversation.id }}/meta" class="form-grid">
      <label>
        Titel
        <input type="text" name="title" value="{{ conversation.title }}" required>
      </label>
      <label>
        Beschreibung / Notiz
        <textarea name="notes" rows="3">{{ conversation.notes or "" }}</textarea>
      </label>
      <button type="submit">Metadaten speichern</button>
    </form>
  </details>
</section>

<section class="card">
  <details class="section-details">
    <summary>
      <span>Verknüpfte Textbausteine</span>
      <span class="muted">Ideation markiert Beiträge, die nicht übernommen wurden.</span>
    </summary>
    {% if project_blocks %}
      <form method="post" action="/p/{{ project.slug }}/conversations/{{ conversation.id }}/links" class="form-grid">
        <label>
          Textbaustein auswählen
          <select name="block_id" required>
            {% for block in project_blocks %}
              <option value="{{ block.id }}">{{ block.title }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Relation
          <select name="relation" required>
            {% for relation in relation_types %}
              <option value="{{ relation }}">{{ relation_labels[relation] }}</option>
            {% endfor %}
          </select>
        </label>
        <button type="submit">Verknüpfung hinzufügen</button>
      </form>
    {% else %}
      <p class="muted">Keine Textbausteine vorhanden, um diese Konversation zuzuordnen.</p>
    {% endif %}
    {% if conversation.links %}
      <ul class="list">
        {% for link in conversation.links %}
          <li class="list-item">
            <div>
              <strong>{{ link.text_block.title }}</strong>
              <p class="muted">Relation: {{ relation_labels[link.relation] }}</p>
              <a href="/p/{{ project.slug }}/blocks/{{ link.text_block.id }}">Zum Textbaustein</a>
            </div>
            <form method="post" action="/p/{{ project.slug }}/conversations/{{ conversation.id }}/links/{{ link.id }}" class="form-inline">
              <select name="relation">
                {% for relation in relation_types %}
                  <option value="{{ relation }}" {% if link.relation == relation %}selected{% endif %}>
                    {{ relation_labels[relation] }}
                  </option>
                {% endfor %}
              </select>
              <button type="submit">Aktualisieren</button>
            </form>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">Noch keine Textbausteine verknüpft.</p>
    {% endif %}
  </details>
</section>

<section class="card">
  <div class="split">
    <h3>Chat</h3>
    <span class="muted">Nachricht senden</span>
  </div>
  {% if error %}
    <p class="error">{{ error }}</p>
  {% endif %}
  {% if model_list_error %}
    <p class="error">{{ model_list_error }}</p>
  {% endif %}
  {% if needs_system_instruction_sync and project_system_instruction %}
    <div class="alert alert-warning">
      <strong>Projektweite System-Instruktion hat sich geändert.</strong>
      <p class="muted">
        Entscheide, ob der Chat auf den neuen Projektstandard aktualisiert werden soll oder die aktuelle
        Konfiguration bestehen bleibt.
      </p>
      <div class="form-inline">
        <form method="post" action="/p/{{ project.slug }}/conversations/{{ conversation.id }}/system/sync">
          <input type="hidden" name="decision" value="update">
          <button type="submit">Aktualisieren</button>
        </form>
        <form method="post" action="/p/{{ project.slug }}/conversations/{{ conversation.id }}/system/sync">
          <input type="hidden" name="decision" value="keep">
          <button type="submit" class="button-secondary">Beibehalten</button>
        </form>
      </div>
    </div>
  {% endif %}
  <details class="chat-config-details">
    <summary>System-Instruktion</summary>
    <form method="post" action="/p/{{ project.slug }}/conversations/{{ conversation.id }}/system" class="form-grid chat-config">
      <label>
        System-Instruktion
        <textarea
          name="system_instruction"
          rows="5"
          placeholder="Beschreibe hier den gewünschten Stil oder die Rolle des Modells."
        >{{ system_instruction }}</textarea>
      </label>
      <p class="muted">
        Diese Instruktion steuert die Antwortweise und wird bei Bedarf für die nächste Nachricht verwendet.
      </p>
      <button type="submit">System-Kontext speichern</button>
    </form>
  </details>
  {% if turns %}
    <ul class="chat-thread">
      {% for turn in turns %}
        <li
          id="turn-{{ turn.id }}"
          class="chat-turn chat-turn-{{ turn.role }}{% if turn.is_match %} chat-turn-match{% endif %}"
        >
          <div class="chat-meta">
            <span class="pill">{{ turn.role }}</span>
            <span class="pill pill-muted">Model: {{ turn.model }}</span>
            <span class="muted">{{ turn.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</span>
          </div>
          <p>{{ turn.content_html }}</p>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">No messages yet. Send the first one below.</p>
  {% endif %}
  <form
    method="post"
    action="/p/{{ project.slug }}/conversations/{{ conversation.id }}/messages"
    class="form-grid message-form"
    data-message-form
  >
    <label>
      Message
      <div class="composer">
        <textarea name="message" rows="6" class="message-textarea" required data-message-input></textarea>
        <div class="composer-actions">
          <div class="composer-actions-left">
            <label class="composer-model">
              Modell
              <select name="model" required>
                {% if available_models %}
                  {% for model in available_models %}
                    <option value="{{ model }}" {% if model == selected_model %}selected{% endif %}>{{ model }}</option>
                  {% endfor %}
                {% else %}
                  <option value="{{ selected_model }}">{{ selected_model }}</option>
                {% endif %}
              </select>
            </label>
            <span class="muted composer-count" data-message-count>0 Zeichen</span>
          </div>
          <button type="submit" class="composer-send">Send</button>
        </div>
      </div>
    </label>
  </form>
  <div class="progress" data-progress hidden>
    <div class="progress-bar" role="progressbar" aria-label="Message processing"></div>
  </div>
  <p id="message-status" class="status-message{% if error %} status-error{% endif %}" aria-live="polite">
    {% if error %}
      Fehler beim Senden – bitte prüfen Sie die Meldung oben.
    {% else %}
      Bereit für eine neue Nachricht.
    {% endif %}
  </p>
</section>
<script>
  const messageForm = document.querySelector("[data-message-form]");
  const messageStatus = document.getElementById("message-status");
  const progressBar = document.querySelector("[data-progress]");
  const messageInput = document.querySelector("[data-message-input]");
  const messageCount = document.querySelector("[data-message-count]");
  const updateCount = () => {
    if (messageInput && messageCount) {
      messageCount.textContent = `${messageInput.value.length} Zeichen`;
    }
  };
  updateCount();
  if (messageInput) {
    messageInput.addEventListener("input", updateCount);
  }
  if (messageForm && messageStatus) {
    messageForm.addEventListener("submit", () => {
      messageStatus.textContent = "Nachricht wird gesendet …";
      messageStatus.classList.add("status-pending");
      const submitButton = messageForm.querySelector("button[type='submit']");
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = "Wird gesendet …";
      }
      if (messageInput) {
        messageInput.setAttribute("readonly", "readonly");
      }
      if (progressBar) {
        progressBar.hidden = false;
      }
    });
  }
</script>
{% endblock %}
