{% extends "base.html" %}
{% block content %}
<section class="card">
  <div class="split">
    <div>
      <h2>{{ conversation.title }}</h2>
      <p class="muted">Source: {{ conversation.source }}</p>
    </div>
    <div class="row-actions">
      <a href="/p/{{ project.slug }}/conversations">All conversations</a>
    </div>
  </div>
</section>

<section class="card">
  <div class="split">
    <div>
      <h3>Verknüpfte Textbausteine</h3>
      <p class="muted">Ideation markiert Beiträge, die nicht übernommen wurden.</p>
    </div>
  </div>
  {% if project_blocks %}
    <form method="post" action="/p/{{ project.slug }}/conversations/{{ conversation.id }}/links" class="form-grid">
      <label>
        Textbaustein auswählen
        <select name="block_id" required>
          {% for block in project_blocks %}
            <option value="{{ block.id }}">{{ block.title }}</option>
          {% endfor %}
        </select>
      </label>
      <label>
        Relation
        <select name="relation" required>
          {% for relation in relation_types %}
            <option value="{{ relation }}">{{ relation_labels[relation] }}</option>
          {% endfor %}
        </select>
      </label>
      <button type="submit">Verknüpfung hinzufügen</button>
    </form>
  {% else %}
    <p class="muted">Keine Textbausteine vorhanden, um diese Konversation zuzuordnen.</p>
  {% endif %}
  {% if conversation.links %}
    <ul class="list">
      {% for link in conversation.links %}
        <li class="list-item">
          <div>
            <strong>{{ link.text_block.title }}</strong>
            <p class="muted">Relation: {{ relation_labels[link.relation] }}</p>
            <a href="/p/{{ project.slug }}/blocks/{{ link.text_block.id }}">Zum Textbaustein</a>
          </div>
          <form method="post" action="/p/{{ project.slug }}/conversations/{{ conversation.id }}/links/{{ link.id }}" class="form-inline">
            <select name="relation">
              {% for relation in relation_types %}
                <option value="{{ relation }}" {% if link.relation == relation %}selected{% endif %}>
                  {{ relation_labels[relation] }}
                </option>
              {% endfor %}
            </select>
            <button type="submit">Aktualisieren</button>
          </form>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">Noch keine Textbausteine verknüpft.</p>
  {% endif %}
</section>

<section class="card">
  <h3>Chat</h3>
  {% if error %}
    <p class="error">{{ error }}</p>
  {% endif %}
  <form method="post" action="/p/{{ project.slug }}/conversations/{{ conversation.id }}/system" class="form-grid chat-config">
    <label>
      System-Instruktion
      <textarea
        name="system_instruction"
        rows="5"
        placeholder="Beschreibe hier den gewünschten Stil oder die Rolle des Modells."
      >{{ system_instruction }}</textarea>
    </label>
    <p class="muted">
      Diese Instruktion steuert die Antwortweise und wird bei Bedarf für die nächste Nachricht verwendet.
    </p>
    <button type="submit">System-Kontext speichern</button>
  </form>
  {% if turns %}
    <ul class="chat-thread">
      {% for turn in turns %}
        <li
          id="turn-{{ turn.id }}"
          class="chat-turn chat-turn-{{ turn.role }}{% if turn.is_match %} chat-turn-match{% endif %}"
        >
          <div class="chat-meta">
            <span class="pill">{{ turn.role }}</span>
            <span class="pill pill-muted">Model: {{ turn.model }}</span>
            <span class="muted">{{ turn.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
          </div>
          <p>{{ turn.content_html }}</p>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">No messages yet. Send the first one below.</p>
  {% endif %}
</section>

<section class="card">
  <h3>Send message</h3>
  <form
    method="post"
    action="/p/{{ project.slug }}/conversations/{{ conversation.id }}/messages"
    class="form-grid message-form"
    data-message-form
  >
    <label>
      Message
      <textarea name="message" rows="8" class="message-textarea" required></textarea>
    </label>
    <button type="submit">Send</button>
  </form>
  <p id="message-status" class="status-message{% if error %} status-error{% endif %}" aria-live="polite">
    {% if error %}
      Fehler beim Senden – bitte prüfen Sie die Meldung oben.
    {% else %}
      Bereit für eine neue Nachricht.
    {% endif %}
  </p>
</section>
<script>
  const messageForm = document.querySelector("[data-message-form]");
  const messageStatus = document.getElementById("message-status");
  if (messageForm && messageStatus) {
    messageForm.addEventListener("submit", () => {
      messageStatus.textContent = "Nachricht wird gesendet …";
      messageStatus.classList.add("status-pending");
      const submitButton = messageForm.querySelector("button[type='submit']");
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = "Wird gesendet …";
      }
      const messageInput = messageForm.querySelector("textarea[name='message']");
      if (messageInput) {
        messageInput.setAttribute("readonly", "readonly");
      }
    });
  }
</script>
{% endblock %}
