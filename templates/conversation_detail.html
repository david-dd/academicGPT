{% extends "base.html" %}
{% block content %}
<section class="card">
  <div class="split">
    <div>
      <h2>{{ conversation.title }}</h2>
      <p class="muted">Source: {{ conversation.source }}</p>
    </div>
    <div class="row-actions">
      <a href="/p/{{ project.slug }}/conversations">All conversations</a>
    </div>
  </div>
</section>

<section class="card">
  <div class="split">
    <div>
      <h3>Verknüpfte Textbausteine</h3>
      <p class="muted">Ideation markiert Beiträge, die nicht übernommen wurden.</p>
    </div>
  </div>
  {% if project_blocks %}
    <form method="post" action="/p/{{ project.slug }}/conversations/{{ conversation.id }}/links" class="form-grid">
      <label>
        Textbaustein auswählen
        <select name="block_id" required>
          {% for block in project_blocks %}
            <option value="{{ block.id }}">{{ block.title }}</option>
          {% endfor %}
        </select>
      </label>
      <label>
        Relation
        <select name="relation" required>
          {% for relation in relation_types %}
            <option value="{{ relation }}">{{ relation_labels[relation] }}</option>
          {% endfor %}
        </select>
      </label>
      <button type="submit">Verknüpfung hinzufügen</button>
    </form>
  {% else %}
    <p class="muted">Keine Textbausteine vorhanden, um diese Konversation zuzuordnen.</p>
  {% endif %}
  {% if conversation.links %}
    <ul class="list">
      {% for link in conversation.links %}
        <li class="list-item">
          <div>
            <strong>{{ link.text_block.title }}</strong>
            <p class="muted">Relation: {{ relation_labels[link.relation] }}</p>
            <a href="/p/{{ project.slug }}/blocks/{{ link.text_block.id }}">Zum Textbaustein</a>
          </div>
          <form method="post" action="/p/{{ project.slug }}/conversations/{{ conversation.id }}/links/{{ link.id }}" class="form-inline">
            <select name="relation">
              {% for relation in relation_types %}
                <option value="{{ relation }}" {% if link.relation == relation %}selected{% endif %}>
                  {{ relation_labels[relation] }}
                </option>
              {% endfor %}
            </select>
            <button type="submit">Aktualisieren</button>
          </form>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">Noch keine Textbausteine verknüpft.</p>
  {% endif %}
</section>

<section class="card">
  <h3>Chat</h3>
  {% if error %}
    <p class="error">{{ error }}</p>
  {% endif %}
  {% if turns %}
    <ul class="chat-thread">
      {% for turn in turns %}
        <li class="chat-turn chat-turn-{{ turn.role }}">
          <div class="chat-meta">
            <span class="pill">{{ turn.role }}</span>
            <span class="muted">{{ turn.timestamp.strftime('%Y-%m-%d %H:%M') }}</span>
          </div>
          <p>{{ turn.content_text }}</p>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">No messages yet. Send the first one below.</p>
  {% endif %}
</section>

<section class="card">
  <h3>Send message</h3>
  <form method="post" action="/p/{{ project.slug }}/conversations/{{ conversation.id }}/messages" class="form-grid">
    <label>
      Message
      <textarea name="message" rows="4" required></textarea>
    </label>
    <button type="submit">Send</button>
  </form>
</section>
{% endblock %}
